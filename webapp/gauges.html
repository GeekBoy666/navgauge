<!DOCTYPE html>
<html >
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <title>Gauges</title>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>

  <script src="lib/tween-min.js"></script>
  <script src="lib/steelseries.js"></script>
  <script src="lib/Bacon.js"></script>
  <script src="lib/bacon.jquery.min.js"></script>
  <script src="primus/primus.js"></script>
  <link  href="css/bootstrap.css" rel="stylesheet"></link>
</head>
<body onload="init();" style="background-color:#000">

<nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>

    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li class="dropdown" id="boatslist">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">Select<b class="caret"></b></a>
          <ul class="dropdown-menu" >
          </ul>
        </li>
      </ul>
      <form class="navbar-form navbar-left">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Boat Model Url">
        </div>
        <button type="submit" class="btn btn-default">Connect</button>
      </form>
      <form class="navbar-form navbar-right">
        <button id="helpbutton"
                type="button"
                class="btn btn-default"
                data-container="body"
                data-toggle="popover"
                data-placement="bottom"
                data-content="Please select a boat from the list or enter your own url that points to a Primus server providing navigation data.">
          Help
        </button>
      </form>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

<canvas id="speedCanvas" width="25%" height="25%"></canvas>
<canvas id="depthCanvas" width="25%" height="25%"></canvas>
<canvas id="compassCanvas" width="25%" height="25%"></canvas>

<script>
  $('#helpbutton').popover();

  var speed;
  var depth;
  var compass;
  var gaugePrimus;

  function connectTo(url) {
    if (typeof gaugePrimus != "undefined" ) {
      console.log("Disconnecting first");
      gaugePrimus.end();
    }

    console.log("Connecting to:" + url);
    gaugePrimus = Primus.connect(url,
        {reconnect: {
          maxDelay: 15000,
          minDelay: 500,
          retries: Infinity
        }});

    gaugePrimus.on('data', function (msg) {
      switch (msg.type) {
        case 'depth':
          depth.setValueAnimated(msg.depth);
          break;
        case 'course':
          compass.setValueAnimated(msg.heading);
          break;
        case 'speed':
          speed.setValueAnimated(msg.knots);
          break;
      }
      switch (msg.id) {
        case 'navigation.headingNorth':
          compass.setValueAnimated(msg.value);
          break;
      }
      gaugeData.push(msg);

    });
  }

  function init() {
    speed = new steelseries.Radial('speedCanvas', {
      gaugeType: steelseries.GaugeType.TYPE4,
      frameDesign: steelseries.FrameDesign.TILTED_BLACK,
      size: 400,
      titleString: "SOG",
      unitString: "knots",
      lcdVisible: true,
      maxValue:10,
      maxMeasuredValue:0,
      maxMeasuredValueVisible:true,
      thresholdVisible:false,
      ledVisible:false,
      pointerType: steelseries.PointerType.TYPE4
    });

    var depthSections = [steelseries.Section(0, 4, 'rgba(255, 0, 0, 0.3)'),
      steelseries.Section(4, 8, 'rgba(220, 220, 0, 0.3)') ];

    depth = new steelseries.Radial('depthCanvas', {
      gaugeType: steelseries.GaugeType.TYPE4,
      frameDesign: steelseries.FrameDesign.TILTED_BLACK,
      size: 400,
      section: depthSections,
      titleString: "Depth",
      unitString: "m",
      lcdVisible: true,
      maxValue:20,
      maxMeasuredValue:0,
      maxMeasuredValueVisible:true,
      thresholdVisible:false,
      ledVisible:false,
      pointerType: steelseries.PointerType.TYPE2
    });

    compass = new steelseries.Compass('compassCanvas', {
      frameDesign: steelseries.FrameDesign.TILTED_BLACK,
      size: 400,
      rotateFace: true,
      pointerType: steelseries.PointerType.TYPE5
    });
  }

  var gaugeData = new Bacon.Bus();

  gaugeData.filter(function(msg){msg.type === 'speed'})
      .scan(0, function(old, incoming) {incoming.knots> old ? incoming.knots : old})
      .changes()
      .onValue(function(value) {
        speed.setMaxMeasuredValue(value);
      });
  gaugeData.filter(function(msg){msg.type === 'depth'})
      .scan(0, function(old, incoming) {incoming.knots> old ? incoming.knots : old})
      .changes()
      .onValue(function(value) {
        depth.setMaxMeasuredValue(value);
      });

  $.ajax({ url : "/api/0.1/vessels"}).done(function(result) {
    var boatslist = $("#boatslist>ul");
    boatslist.empty();
    result.forEach(function(boat) {
      boatslist.append(
          $('<li/>').append(
              $('<a/>').text(boat.name).attr('data-href', boat.primusHref)
          )
      )
    });
    var boatClicks = $("#boatslist>ul>li>a").asEventStream('click');
    boatClicks.onValue(function(msg) {
      var url = msg.target.attributes['data-href'].value;
      if (!url.indexOf('http://')) {
        url = "http://" + window.location.host + url;
      }
      connectTo(url);
      speed.setMaxMeasuredValue(0);
      depth.setMaxMeasuredValue(0);
      speed.setValue(0);
      depth.setValue(0);
      compass.setValue(0);
    });
    boatClicks.map('.target.text').assign($("#boatslist>a"), 'text');
  });
</script>


</body>
</html>
