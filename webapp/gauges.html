<!DOCTYPE html>
<html >
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <title>Gauges</title>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>

  <script src="lib/tween-min.js"></script>
  <script src="lib/steelseries.js"></script>
  <script src="lib/Bacon.js"></script>
  <script src="lib/bacon.jquery.min.js"></script>
  <script src="primus/primus.js"></script>
  <link  href="css/bootstrap.css" rel="stylesheet"></link>
</head>
<body onload="init();" style="background-color:#000">

<nav class="navbar navbar-default" role="navigation">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>

    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        <li class="dropdown" id="boatslist">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">Select<b class="caret"></b></a>
          <ul class="dropdown-menu" >
          </ul>
        </li>
      </ul>
      <form class="navbar-form navbar-left">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Boat Model Url">
        </div>
        <button type="submit" class="btn btn-default">Connect</button>
      </form>
      <form class="navbar-form navbar-right">
        <button id="helpbutton"
                type="button"
                class="btn btn-default"
                data-container="body"
                data-toggle="popover"
                data-placement="bottom"
                data-content="Please select a boat from the list or enter your own url that points to a Primus server providing navigation data.">
          Help
        </button>
      </form>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

<canvas id="speedCanvas" ></canvas>
<canvas id="depthCanvas" ></canvas>
<canvas id="compassCanvas"></canvas>
<canvas id="windCanvas"></canvas>


<script>
  $('#helpbutton').popover();

  var speed;
  var depth;
  var compass;
  var wind;
  var gaugePrimus;

  var propertyIs = function(key, value) {
    return function(obj) {
      return obj[key] === value;
    };
  };

  var bus = new Bacon.Bus();

  bus.filter(propertyIs('id', 'navigation.headingNorth')).onValue(function(msg){
    compass.setValueAnimated(msg.value);
  });
  bus.filter(propertyIs('id', 'navigation.depth')).onValue(function(msg){
    depth.setValueAnimated(msg.value);
  });
  bus.filter(propertyIs('id', 'navigation.speedOverGround')).onValue(function(msg){
    speed.setValueAnimated(msg.value);
  });
  bus.filter(propertyIs('id', 'environmental.apparentWindDirection')).onValue(function(msg){
    wind.setValueAnimatedLatest(msg.value);
  });


  function connectTo(url) {
    console.log("Connecting to:" + url);
    gaugePrimus = Primus.connect(url,
        {reconnect: {
          maxDelay: 15000,
          minDelay: 500,
          retries: Infinity
        }});

    gaugePrimus.on('data', function (msg) {
      bus.push(msg);
    });
  }

  function init() {
    speed = new steelseries.Radial('speedCanvas', {
      gaugeType: steelseries.GaugeType.TYPE4,
      frameDesign: steelseries.FrameDesign.TILTED_BLACK,
      size: 400,
      titleString: "SOG",
      unitString: "knots",
      lcdVisible: true,
      maxValue:10,
      maxMeasuredValue:0,
      maxMeasuredValueVisible:true,
      thresholdVisible:false,
      ledVisible:false,
      pointerType: steelseries.PointerType.TYPE4
    });

    var depthSections = [steelseries.Section(0, 4, 'rgba(255, 0, 0, 0.3)'),
      steelseries.Section(4, 8, 'rgba(220, 220, 0, 0.3)') ];

    depth = new steelseries.Radial('depthCanvas', {
      gaugeType: steelseries.GaugeType.TYPE4,
      frameDesign: steelseries.FrameDesign.TILTED_BLACK,
      size: 400,
      section: depthSections,
      titleString: "Depth",
      unitString: "m",
      lcdVisible: true,
      maxValue:20,
      maxMeasuredValue:0,
      maxMeasuredValueVisible:true,
      thresholdVisible:false,
      ledVisible:false,
      pointerType: steelseries.PointerType.TYPE2
    });

    compass = new steelseries.Compass('compassCanvas', {
      frameDesign: steelseries.FrameDesign.TILTED_BLACK,
      size: 400,
      rotateFace: true,
      pointerType: steelseries.PointerType.TYPE5
    });

    wind = new steelseries.WindDirection('windCanvas', {
      frameDesign: steelseries.FrameDesign.TILTED_BLACK,
      size: 400,
      lcdVisible: true,
      degreeScaleHalf: true,
      pointSymbolsVisible: false,
      pointerType: steelseries.PointerType.TYPE5,
    });

  }


  $.ajax({ url : "/api/0.1/vessels"}).done(function(result) {
    var boatslist = $("#boatslist>ul");
    boatslist.empty();
    result.forEach(function(boat) {
      boatslist.append(
          $('<li/>').append(
              $('<a/>').text(boat.name).attr('data-href', boat.primusHref)
          )
      )
    });
    var boatClicks = $("#boatslist>ul>li>a").asEventStream('click');
    boatClicks.onValue(function(msg) {
      var url = msg.target.attributes['data-href'].value;
      if (!url.indexOf('http://')) {
        url = "http://" + window.location.host + url;
      }
      if (typeof gaugePrimus != "undefined" ) {
        console.log("Disconnecting");
        gaugePrimus.end();
      }
      //wait 500 milliseconds for all previous messages to be supposedly handled first
      setTimeout(function(){
        speed.setMaxMeasuredValue(0);
        depth.setMaxMeasuredValue(0);
        speed.setValue(0);
        depth.setValue(0);
        compass.setValue(0);
        connectTo(url);
      }, 500);
    });
    boatClicks.map('.target.text').assign($("#boatslist>a"), 'text');
  });
</script>


</body>
</html>
